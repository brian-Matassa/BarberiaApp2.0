<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Style</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Urban Style">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="manifest" href="manifest.json">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Urban Style */
        :root {
            /* New Color Palette: Blue & Orange */
            --primary-color: #fca311;   /* Vibrant Orange */
            --secondary-color: #14213d;  /* Dark Blue */
            --background-dark: #000000;   /* Deep Black */
            --text-light: #e5e5e5;       /* Off-white */
            --card-bg: #1a1a1a;          /* Darker gray for cards */
            --accent-green: #22c55e;
            --accent-red: #ef4444;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1.5rem;
        }

        .app-container {
            max-width: 600px;
            width: 100%;
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            border: 1px solid #3d3d3d;
        }

        .header {
            background: linear-gradient(135deg, var(--secondary-color), var(--card-bg));
            color: var(--primary-color);
            padding: 2.5rem 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
            border-bottom: 2px solid var(--primary-color);
        }

        .header h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 2.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .header p {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.25rem;
            font-weight: 400;
            color: #a3a3a3;
        }

        .card {
            background-color: #1f2833;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 1.5rem;
            border: 1px solid #2e4d58;
        }

        h2, h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            text-transform: uppercase;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.25);
            opacity: 0.9;
        }

        .btn-secondary {
            background-color: #5a5f67;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-delete {
            background-color: var(--accent-red);
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-delete:hover {
            background-color: #dc2626;
        }
        
        .btn-complete {
            background-color: var(--accent-green);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .btn-complete:hover {
            background-color: #16a34a;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        textarea,
        select {
            background-color: #2e4d58;
            color: var(--text-light);
            border: 1px solid #3b4c5d;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(252, 163, 17, 0.5);
        }

        /* Hide screens by default */
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #3b4c5d;
        }
        .stats-item:last-child {
            border-bottom: none;
        }
        .stats-label {
            font-weight: 600;
            color: var(--text-light);
            font-family: 'Montserrat', sans-serif;
        }
        .stats-value {
            font-weight: 700;
            color: var(--primary-color);
            font-family: 'Montserrat', sans-serif;
        }

        /* Calendar specific styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
        }

        .calendar-grid.day-labels span {
            font-size: 0.75rem;
        }
        
        @media (min-width: 640px) {
            .calendar-grid.day-labels span {
                font-size: 0.875rem;
            }
        }
        
        .calendar-day {
            padding: 0.75rem 0.25rem;
            border-radius: 0.5rem;
            background-color: #2e4d58;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-weight: 500;
            color: #a3a3a3;
            border: 1px solid #4b5563;
        }
        .calendar-day:hover {
            background-color: #3b4c5d;
            transform: translateY(-1px);
        }
        .calendar-day.inactive {
            color: #4b5563;
            background-color: #1f2833;
            cursor: default;
        }
        .calendar-day.selected {
            background-color: var(--primary-color);
            color: var(--background-dark);
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border-color: var(--primary-color);
        }
        .calendar-day.has-appointments {
            border: 2px solid var(--accent-green);
        }
        .calendar-day.today {
            border: 2px solid #f59e0b;
        }

        /* Modal specific styles */
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            max-width: 450px;
            width: 90%;
            border: 1px solid var(--secondary-color);
        }

        /* Time slot buttons */
        .time-slot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .time-slot-btn {
            padding: 0.75rem 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid;
            font-family: 'Roboto', sans-serif;
        }
        .time-slot-btn.available {
            background-color: #1e3a2e;
            color: #99f6e4;
            border-color: var(--accent-green);
        }
        .time-slot-btn.available:hover {
            background-color: var(--accent-green);
            color: var(--background-dark);
            transform: scale(1.05);
        }
        .time-slot-btn.occupied {
            background-color: #4b2a2a;
            color: #fca5a5;
            border-color: var(--accent-red);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .time-slot-btn.selected-slot {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            color: var(--background-dark);
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
        }
        .client-item {
            background-color: #1f2833;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #2e4d58;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .client-item:hover {
            transform: translateY(-2px);
            background-color: #283747;
        }
        .appointment-item {
            background-color: #283747;
            border-color: #3b4c5d;
        }

        .appointment-item.completed {
            background-color: #1b2734;
            color: #8c8c8c;
            text-decoration: line-through;
            opacity: 0.8;
            border-color: #1a232f;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1 class="text-3xl font-bold mb-2">Urban Style</h1>
            <p class="text-lg">Gestión Personal</p>
        </header>

        <div id="main-menu-screen" class="screen active p-6">
            <h2 class="text-2xl font-semibold mb-6 text-center">Bienvenido</h2>
            
            <section class="card mb-6">
                <h3 class="text-xl font-semibold mb-4 text-center">Resumen del Día</h3>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <p class="text-sm text-gray-400">Cortes Hoy</p>
                        <p id="dashboardDailyCuts" class="text-4xl font-bold text-primary-color mt-1">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Dinero Hoy</p>
                        <p id="dashboardDailyEarnings" class="text-4xl font-bold text-green-400 mt-1">$0.00</p>
                    </div>
                </div>
            </section>
            
            <div class="flex flex-col space-y-4">
                <button id="goToAppointments" class="btn-primary w-full text-xl py-4 rounded-lg">
                    Gestión de Citas
                </button>
                <button id="goToClients" class="btn-primary w-full text-xl py-4 rounded-lg">
                    Gestión de Clientes
                </button>
                <button id="goToCutCounter" class="btn-primary w-full text-xl py-4 rounded-lg">
                    Contador de Cortes y Dinero
                </button>
                <button id="goToStats" class="btn-primary w-full text-xl py-4 rounded-lg">
                    Estadísticas de Cortes
                </button>
            </div>
        </div>

        <div id="appointments-screen" class="screen p-6">
            <button id="backToMainFromAppointments" class="btn-secondary mb-4">Volver al Inicio</button>
            <section class="card">
                <h2 class="text-2xl font-semibold mb-4 text-center">Calendario de Reservas</h2>

                <div class="flex flex-col items-center mb-4">
                    <div class="flex justify-between items-center w-full max-w-xs mb-2">
                        <button id="calendarPrevMonth" class="btn-secondary px-3 py-1 rounded-full text-lg">&lt;</button>
                        <span id="calendarMonthYear" class="text-xl font-semibold text-primary-color"></span>
                        <button id="calendarNextMonth" class="btn-secondary px-3 py-1 rounded-full text-lg">&gt;</button>
                    </div>
                    <div class="calendar-grid day-labels text-sm font-medium text-gray-400">
                        <span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span>
                    </div>
                    <div id="calendarDaysGrid" class="calendar-grid">
                    </div>
                </div>
                <p id="selectedDateDisplay" class="text-center text-gray-400 mb-4">Día seleccionado: <span class="font-bold text-primary-color">Hoy</span></p>

                <button id="addAppointmentForSelectedDayBtn" class="btn-primary w-full mt-2">Añadir Cita para el día seleccionado</button>
                <button id="goToDailyManagementBtn" class="btn-secondary w-full mt-2">Gestionar Citas del Día</button>
            </section>
            </div>

        <div id="client-management-screen" class="screen p-6">
            <button id="backToMainFromClients" class="btn-secondary mb-4">Volver al Inicio</button>
            <section class="card">
                <h2 class="text-2xl font-semibold mb-4 text-center">Gestión de Clientes</h2>
                <form id="clientForm" data-editing-id="" class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-400 mb-1">Nombre</label>
                        <input type="text" id="clientName" placeholder="Ej: Juan Pérez" required
                               class="focus:ring-primary-color focus:border-primary-color block w-full rounded-md">
                    </div>
                    <div>
                        <label for="clientPhone" class="block text-sm font-medium text-gray-400 mb-1">Teléfono</label>
                        <input type="text" id="clientPhone" placeholder="Ej: +5491122334455"
                               class="focus:ring-primary-color focus:border-primary-color block w-full rounded-md">
                    </div>
                    <div>
                        <label for="clientNotes" class="block text-sm font-medium text-gray-400 mb-1">Notas</label>
                        <textarea id="clientNotes" placeholder="Corte favorito, preferencias..." rows="3"
                                  class="focus:ring-primary-color focus:border-primary-color block w-full rounded-md"></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" id="saveClientBtn" class="btn-primary w-full mt-2">Guardar Cliente</button>
                        <button type="button" id="cancelEditBtn" class="btn-secondary w-full mt-2 hidden">Cancelar Edición</button>
                    </div>
                </form>
            </section>
            <section class="card mt-6">
                <h3 class="text-xl font-semibold mb-4 text-center">Mis Clientes</h3>
                <div id="clientsList" class="space-y-4">
                    <p id="noClientsMessage" class="text-center text-gray-500">No tienes clientes guardados.</p>
                </div>
            </section>
        </div>

        <div id="client-details-screen" class="screen p-6">
            <button id="backToClientsFromDetails" class="btn-secondary mb-4">Volver a Clientes</button>
            <section class="card">
                <h2 id="clientDetailsName" class="text-2xl font-semibold mb-2"></h2>
                <p id="clientDetailsPhone" class="text-gray-400 mb-4"></p>
                <div class="flex justify-start space-x-2 mt-2">
                    <a id="clientDetailsCall" href="#" class="text-blue-400 hover:text-blue-300 hidden">Llamar</a>
                    <a id="clientDetailsWhatsApp" href="#" target="_blank" class="text-green-400 hover:text-green-300 hidden">WhatsApp</a>
                </div>
            </section>
            <section class="card mt-6">
                <h3 class="text-xl font-semibold mb-4 text-center">Historial de Cortes (<span id="cutCountDisplay">0</span>)</h3>
                <div id="clientCutsHistoryList" class="space-y-2">
                    <p id="noCutsMessage" class="text-center text-gray-500">Este cliente aún no tiene cortes registrados.</p>
                </div>
            </section>
        </div>

        <div id="daily-appointments-screen" class="screen p-6">
            <button id="backToMainFromDaily" class="btn-secondary mb-4">Volver al Inicio</button>
            <section class="card">
                <h2 class="text-2xl font-semibold mb-4 text-center">Gestión de Citas Diarias</h2>
                
                <div class="flex items-center justify-between mb-4">
                    <button id="dailyPrevDayBtn" class="btn-secondary px-3 py-1 rounded-full text-lg">&lt;</button>
                    <span id="dailyDateDisplay" class="text-xl font-semibold text-primary-color"></span>
                    <button id="dailyNextDayBtn" class="btn-secondary px-3 py-1 rounded-full text-lg">&gt;</button>
                </div>
                
                <h3 class="text-xl font-semibold mb-3 text-center">Citas para el día seleccionado</h3>
                <div id="dailyAppointmentsList" class="space-y-3">
                    <p id="noDailyAppointmentsMessage" class="text-center text-gray-500">No hay citas para este día.</p>
                </div>
                
                <button id="addNewAppointmentFromDailyBtn" class="btn-primary w-full mt-6">Añadir Cita</button>
                <button id="goToCalendarFromDaily" class="btn-secondary w-full mt-2">Ver Calendario de Reservas</button>
            </section>
        </div>

        <div id="appointmentModal" class="fixed inset-0 modal z-50 hidden">
            <div class="modal-content">
                <h3 class="text-xl font-semibold mb-4 text-center">Añadir Nueva Cita</h3>
                <form id="modalAppointmentForm" class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="modalClientName" class="block text-sm font-medium text-gray-400 mb-1">Nombre del Cliente</label>
                        <input type="text" id="modalClientName" placeholder="Ej: Juan Pérez" required
                               class="focus:ring-primary-color focus:border-primary-color block w-full rounded-md">
                    </div>
                    <div>
                        <label for="modalAppointmentDate" class="block text-sm font-medium text-gray-400 mb-1">Fecha</label>
                        <input type="date" id="modalAppointmentDate" required readonly
                               class="focus:ring-primary-color focus:border-primary-color block w-full rounded-md bg-gray-600 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Hora</label>
                        <div id="timeSlotsContainer" class="time-slot-grid">
                        </div>
                        <input type="hidden" id="modalAppointmentTime" required>
                    </div>
                    <button type="submit" class="btn-primary w-full mt-2">Guardar Cita</button>
                    <button type="button" id="closeAppointmentModal" class="btn-secondary w-full mt-2">Cancelar</button>
                </form>
            </div>
        </div>

        <div id="cut-counter-screen" class="screen p-6">
            <button id="backToMainFromCounter" class="btn-secondary mb-4">Volver al Inicio</button>
            <section class="card">
                <h2 class="text-2xl font-semibold mb-4 text-center">Contador de Cortes y Dinero</h2>
                <div class="text-center mb-6">
                    <p class="text-xl font-bold mb-2">Cortes Hoy: <span id="dailyCutsDisplay" class="text-primary-color">0</span></p>
                    <p class="text-xl font-bold">Dinero Hoy: $<span id="dailyEarningsDisplay" class="text-green-400">0.00</span></p>
                </div>
                <div class="flex flex-col gap-4">
                    <div>
                        <label for="cutAmount" class="block text-sm font-medium text-gray-400 mb-1">Monto del Corte ($)</label>
                        <input type="number" id="cutAmount" value="10000" min="0" step="0.01" required
                               class="focus:ring-primary-color focus:border-primary-color block w-full rounded-md">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="registerTransferBtn" class="bg-[#246299] text-white font-semibold py-4 rounded-lg flex flex-col items-center justify-center">
                            <img src="logo-mercadopago9.png" alt="Logo de Mercado Pago" class="w-12 h-12 mb-2">
                            <span>Transferencia</span>
                        </button>
                        <button id="registerCashBtn" class="bg-green-600 text-white font-semibold py-4 rounded-lg flex flex-col items-center justify-center">
                            <img src="efectivo.jpg" alt="Icono de un billete" class="w-12 h-12 mb-2">
                            <span>Efectivo</span>
                        </button>
                    </div>
                    <button id="undoLastCutBtn" class="btn-delete w-full">Cancelar Último Corte</button>
                </div>
                <div class="text-center mt-6">
                    <p class="text-lg font-bold">Transferencia: <span id="transferCutsDisplay" class="text-primary-color">0</span> Cortes</p>
                    <p class="text-lg font-bold">Efectivo: <span id="cashCutsDisplay" class="text-primary-color">0</span> Cortes</p>
                </div>
            </section>
        </div>

        <div id="stats-screen" class="screen p-6">
            <button id="backToMainFromStats" class="btn-secondary mb-4">Volver al Inicio</button>
            <section class="card">
                <h2 class="text-2xl font-semibold mb-4 text-center">Estadísticas de Cortes</h2>

                <div class="flex items-center justify-between mb-4">
                    <button id="statsPrevDayBtn" class="btn-secondary px-3 py-1 rounded-full text-lg">&lt;</button>
                    <span id="statsDayDisplay" class="text-xl font-semibold text-primary-color"></span>
                    <button id="statsNextDayBtn" class="btn-secondary px-3 py-1 rounded-full text-lg">&gt;</button>
                </div>

                <div class="flex items-center justify-between mb-6">
                    <button id="statsPrevMonthBtn" class="btn-secondary px-3 py-1 rounded-full text-lg">&lt;&lt;</button>
                    <span id="statsMonthDisplay" class="text-xl font-semibold text-primary-color"></span>
                    <button id="statsNextMonthBtn" class="btn-secondary px-3 py-1 rounded-full text-lg">&gt;&gt;</button>
                </div>

                <div class="space-y-4">
                    <div class="stats-item">
                        <span class="stats-label">Cortes del Día:</span>
                        <span id="statsDailyCuts" class="stats-value">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Dinero del Día:</span>
                        <span id="statsDailyEarnings" class="stats-value">$0.00</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Cortes de la Semana:</span>
                        <span id="statsWeeklyCuts" class="stats-value">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Dinero de la Semana:</span>
                        <span id="statsWeeklyEarnings" class="stats-value">$0.00</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Cortes del Mes:</span>
                        <span id="statsMonthlyCuts" class="stats-value">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Dinero del Mes:</span>
                        <span id="statsMonthlyEarnings" class="stats-value">$0.00</span>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // --- Screen Navigation Logic ---
        const mainMenuScreen = document.getElementById('main-menu-screen');
        const appointmentsScreen = document.getElementById('appointments-screen'); // Calendario de Reservas
        const dailyAppointmentsScreen = document.getElementById('daily-appointments-screen'); // Gestión Diaria (NUEVO)
        const cutCounterScreen = document.getElementById('cut-counter-screen');
        const statsScreen = document.getElementById('stats-screen');
        const clientManagementScreen = document.getElementById('client-management-screen');
        const clientDetailsScreen = document.getElementById('client-details-screen');

        const goToAppointmentsBtn = document.getElementById('goToAppointments');
        const goToClientsBtn = document.getElementById('goToClients');
        const goToCutCounterBtn = document.getElementById('goToCutCounter');
        const goToStatsBtn = document.getElementById('goToStats');
        const backToMainFromAppointmentsBtn = document.getElementById('backToMainFromAppointments');
        const backToMainFromClientsBtn = document.getElementById('backToMainFromClients');
        const backToMainFromCounterBtn = document.getElementById('backToMainFromCounter');
        const backToMainFromStatsBtn = document.getElementById('backToMainFromStats');
        const backToClientsFromDetailsBtn = document.getElementById('backToClientsFromDetails');
        
        // NUEVOS botones de navegación
        const goToDailyManagementBtn = document.getElementById('goToDailyManagementBtn');
        const backToMainFromDailyBtn = document.getElementById('backToMainFromDaily');
        const addNewAppointmentFromDailyBtn = document.getElementById('addNewAppointmentFromDailyBtn');
        const goToCalendarFromDailyBtn = document.getElementById('goToCalendarFromDaily');

        // Dashboard elements
        const dashboardDailyCuts = document.getElementById('dashboardDailyCuts');
        const dashboardDailyEarnings = document.getElementById('dashboardDailyEarnings');
        

        // Function to show a specific screen and hide others
        function showScreen(screenToShow) {
            // Hide all screens first
            mainMenuScreen.classList.remove('active');
            appointmentsScreen.classList.remove('active');
            cutCounterScreen.classList.remove('active');
            statsScreen.classList.remove('active');
            clientManagementScreen.classList.remove('active');
            clientDetailsScreen.classList.remove('active');
            dailyAppointmentsScreen.classList.remove('active'); // NUEVO

            // Show the requested screen
            screenToShow.classList.add('active');

            // Toggle header visibility based on screen
            const header = document.querySelector('header');
            if (screenToShow === appointmentsScreen || screenToShow === clientManagementScreen || screenToShow === clientDetailsScreen || screenToShow === dailyAppointmentsScreen) {
                header.style.display = 'none';
            } else {
                header.style.display = 'block';
            }

            // --- Lógica para cada pantalla ---
            if (screenToShow === appointmentsScreen) { // Calendario de Reservas
                currentCalendarDate = new Date();
                selectedCalendarDate = new Date(); // Select today by default
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
                // La visualización de citas se movió a dailyAppointmentsScreen
                const today = selectedCalendarDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                selectedDateDisplay.innerHTML = `Día seleccionado: <span class="font-bold text-primary-color">${today}</span>`;
            }
            if (screenToShow === dailyAppointmentsScreen) { // Gestión Diaria
                // Inicializa la fecha de gestión al día actual si no está definida
                if (!selectedDailyDate) {
                    selectedDailyDate = new Date();
                }
                displayDailyManagement(selectedDailyDate.toISOString().slice(0, 10));
            }
            if (screenToShow === clientManagementScreen) {
                renderClients();
            }
            if (screenToShow === cutCounterScreen) {
                loadDailyStats();
            }
            if (screenToShow === statsScreen) {
                currentStatsDisplayDate = new Date();
                loadDailyStats();
                updateOverallStatsDisplay();
            }
            // Lógica añadida para actualizar el dashboard al volver al menú principal
            if (screenToShow === mainMenuScreen) {
                updateDashboardStats();
            }
        }

        // Event listeners for navigation buttons
        goToAppointmentsBtn.addEventListener('click', () => showScreen(appointmentsScreen)); // Main menu to Calendar
        goToClientsBtn.addEventListener('click', () => showScreen(clientManagementScreen));
        goToCutCounterBtn.addEventListener('click', () => showScreen(cutCounterScreen));
        goToStatsBtn.addEventListener('click', () => showScreen(statsScreen));
        backToMainFromAppointmentsBtn.addEventListener('click', () => showScreen(mainMenuScreen));
        backToMainFromClientsBtn.addEventListener('click', () => showScreen(mainMenuScreen));
        backToMainFromCounterBtn.addEventListener('click', () => showScreen(mainMenuScreen));
        backToMainFromStatsBtn.addEventListener('click', () => showScreen(mainMenuScreen));
        backToClientsFromDetailsBtn.addEventListener('click', () => showScreen(clientManagementScreen));

        // NUEVOS event listeners
        goToDailyManagementBtn.addEventListener('click', () => {
            selectedDailyDate = selectedCalendarDate; // Usar el día del calendario como punto de partida
            showScreen(dailyAppointmentsScreen);
        });
        backToMainFromDailyBtn.addEventListener('click', () => showScreen(mainMenuScreen));
        goToCalendarFromDailyBtn.addEventListener('click', () => showScreen(appointmentsScreen));


        // --- Appointment Management Logic ---
        const calendarMonthYear = document.getElementById('calendarMonthYear');
        const calendarDaysGrid = document.getElementById('calendarDaysGrid');
        const calendarPrevMonth = document.getElementById('calendarPrevMonth');
        const calendarNextMonth = document.getElementById('calendarNextMonth');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay'); // En appointments-screen
        
        // Elementos de la nueva pantalla 'daily-appointments-screen'
        const dailyDateDisplay = document.getElementById('dailyDateDisplay');
        const dailyPrevDayBtn = document.getElementById('dailyPrevDayBtn');
        const dailyNextDayBtn = document.getElementById('dailyNextDayBtn');
        const dailyAppointmentsList = document.getElementById('dailyAppointmentsList');
        const noDailyAppointmentsMessage = document.getElementById('noDailyAppointmentsMessage');
        const addAppointmentForSelectedDayBtn = document.getElementById('addAppointmentForSelectedDayBtn');

        // Modal elements
        const appointmentModal = document.getElementById('appointmentModal');
        const modalAppointmentForm = document.getElementById('modalAppointmentForm');
        const modalClientName = document.getElementById('modalClientName');
        const modalAppointmentDate = document.getElementById('modalAppointmentDate');
        const modalAppointmentTime = document.getElementById('modalAppointmentTime');
        const timeSlotsContainer = document.getElementById('timeSlotsContainer');
        const closeAppointmentModalBtn = document.getElementById('closeAppointmentModal');

        let currentCalendarDate = new Date();
        let selectedCalendarDate = new Date();
        let selectedDailyDate = new Date(); // Para la gestión diaria

        const fixedTimeSlots = [
            "09:00", "09:20", "09:40", "10:00", "10:20", "10:40",
            "11:00", "11:20", "11:40", "12:00", "12:20", "12:40",
        ];

        const FIXED_APPOINTMENT_PRICE = 10000;

        function loadAppointments() {
            const appointments = JSON.parse(localStorage.getItem('barbershopAppointments')) || [];
            return appointments;
        }

        function saveAppointments(appointments) {
            localStorage.setItem('barbershopAppointments', JSON.stringify(appointments));
        }

        function renderCalendar(year, month) {
            calendarDaysGrid.innerHTML = '';
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();

            let startDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday
            if (startDayOfWeek === 0) startDayOfWeek = 7; // Treat Sunday as the 7th day for display logic

            // Start with Tuesday (index 2)
            let emptyDaysBefore = (startDayOfWeek > 1) ? startDayOfWeek - 2 : 5;

            calendarMonthYear.textContent = firstDay.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

            for (let i = 0; i < emptyDaysBefore; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day inactive';
                calendarDaysGrid.appendChild(emptyDay);
            }

            const todayISO = new Date().toISOString().slice(0, 10);
            const selectedISO = selectedCalendarDate.toISOString().slice(0, 10);
            const allAppointments = loadAppointments();

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay(); // 0=Sunday, 1=Monday, ...

                // Skip Sunday (0) and Monday (1)
                if (dayOfWeek === 1 || dayOfWeek === 0) {
                    continue;
                }

                const dayElement = document.createElement('div');
                dayElement.textContent = day;
                dayElement.className = 'calendar-day';
                
                const currentDayISO = currentDate.toISOString().slice(0, 10);

                if (currentDayISO === todayISO) {
                    dayElement.classList.add('today');
                }
                
                const hasAppointments = allAppointments.some(app => app.date === currentDayISO);
                if (hasAppointments) {
                    dayElement.classList.add('has-appointments');
                }

                if (currentDayISO === selectedISO) {
                    dayElement.classList.add('selected');
                }

                dayElement.dataset.date = currentDayISO;
                dayElement.addEventListener('click', () => {
                    const prevSelected = document.querySelector('.calendar-day.selected');
                    if (prevSelected) {
                        prevSelected.classList.remove('selected');
                    }
                    dayElement.classList.add('selected');
                    selectedCalendarDate = new Date(year, month, day);
                    const dateText = selectedCalendarDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                    selectedDateDisplay.innerHTML = `Día seleccionado: <span class="font-bold text-primary-color">${dateText}</span>`;
                });
                calendarDaysGrid.appendChild(dayElement);
            }
        }
        
        // FUNCIÓN NUEVA: Muestra las citas en la pantalla de gestión diaria
        function displayDailyManagement(dateISO) {
            const appointments = loadAppointments();
            const dailyAppointments = appointments.filter(app => app.date === dateISO);
            dailyAppointmentsList.innerHTML = '';
            
            const dateText = new Date(dateISO).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            dailyDateDisplay.textContent = dateText.charAt(0).toUpperCase() + dateText.slice(1);

            if (dailyAppointments.length === 0) {
                noDailyAppointmentsMessage.style.display = 'block';
            } else {
                noDailyAppointmentsMessage.style.display = 'none';
                dailyAppointments.sort((a, b) => {
                    return a.time.localeCompare(b.time);
                });

                dailyAppointments.forEach(app => {
                    const appElement = document.createElement('div');
                    appElement.className = `appointment-item p-4 rounded-lg flex justify-between items-center border border-gray-700 ${app.completed ? 'completed' : ''}`;
                    appElement.innerHTML = `
                        <div>
                            <p class="font-semibold text-lg">${app.time} - ${app.clientName}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn-complete text-sm ${app.completed ? 'hidden' : ''}" data-id="${app.id}">Completar</button>
                            <button class="btn-delete text-sm" data-id="${app.id}">Eliminar</button>
                        </div>
                    `;
                    dailyAppointmentsList.appendChild(appElement);
                });
            }
        }

        // Navegación de días en la pantalla de gestión diaria
        dailyPrevDayBtn.addEventListener('click', () => {
            selectedDailyDate.setDate(selectedDailyDate.getDate() - 1);
            displayDailyManagement(selectedDailyDate.toISOString().slice(0, 10));
        });

        dailyNextDayBtn.addEventListener('click', () => {
            selectedDailyDate.setDate(selectedDailyDate.getDate() + 1);
            displayDailyManagement(selectedDailyDate.toISOString().slice(0, 10));
        });
        
        addNewAppointmentFromDailyBtn.addEventListener('click', () => {
            // Usa la fecha seleccionada en la gestión diaria para la nueva cita
            modalAppointmentDate.value = selectedDailyDate.toISOString().slice(0, 10);
            renderTimeSlots(modalAppointmentDate.value);
            appointmentModal.style.display = 'flex';
        });

        function saveNewAppointment(clientName, date, time) {
            const appointments = loadAppointments();
            const newAppointment = {
                id: Date.now().toString(),
                clientName,
                date,
                time,
                completed: false
            };
            appointments.push(newAppointment);
            saveAppointments(appointments);
        }

        function deleteAppointment(id) {
            let appointments = loadAppointments();
            appointments = appointments.filter(app => app.id !== id);
            saveAppointments(appointments);
            
            // Re-renderiza ambas vistas si están activas
            if (appointmentsScreen.classList.contains('active')) {
                 renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
            if (dailyAppointmentsScreen.classList.contains('active')) {
                displayDailyManagement(selectedDailyDate.toISOString().slice(0, 10));
            }
        }

        function markAppointmentAsCompleted(id) {
            let appointments = loadAppointments();
            const appointment = appointments.find(app => app.id === id);
            if (appointment) {
                appointment.completed = true;
                // Aquí es donde en el futuro podrías llamar a la función de registro de corte
                // (por ahora sólo marca como completado)
                saveAppointments(appointments);
                
                // Re-renderiza la lista de gestión diaria
                if (dailyAppointmentsScreen.classList.contains('active')) {
                    displayDailyManagement(selectedDailyDate.toISOString().slice(0, 10));
                }
            }
        }

        calendarPrevMonth.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        });

        calendarNextMonth.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        });

        addAppointmentForSelectedDayBtn.addEventListener('click', () => {
            modalAppointmentDate.value = selectedCalendarDate.toISOString().slice(0, 10);
            // Render time slots for the selected date
            renderTimeSlots(modalAppointmentDate.value);
            appointmentModal.style.display = 'flex';
        });

        closeAppointmentModalBtn.addEventListener('click', () => {
            appointmentModal.style.display = 'none';
        });

        function renderTimeSlots(date) {
            const appointments = loadAppointments();
            const dailyAppointments = appointments.filter(app => app.date === date);
            timeSlotsContainer.innerHTML = '';
            modalAppointmentTime.value = '';

            fixedTimeSlots.forEach(slot => {
                const isOccupied = dailyAppointments.some(app => app.time === slot);
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = slot;
                button.className = `time-slot-btn ${isOccupied ? 'occupied' : 'available'}`;
                button.dataset.time = slot;
                button.disabled = isOccupied;

                if (!isOccupied) {
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.time-slot-btn').forEach(btn => btn.classList.remove('selected-slot'));
                        button.classList.add('selected-slot');
                        modalAppointmentTime.value = slot;
                    });
                }
                timeSlotsContainer.appendChild(button);
            });
        }
        
        modalAppointmentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const clientName = modalClientName.value.trim();
            const date = modalAppointmentDate.value;
            const time = modalAppointmentTime.value;

            if (clientName && date && time) {
                saveNewAppointment(clientName, date, time);
                // Actualiza el calendario para mostrar el punto verde
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
                // Si la pantalla de gestión diaria está activa para esa fecha, actualiza la lista
                if (dailyAppointmentsScreen.classList.contains('active') && selectedDailyDate.toISOString().slice(0, 10) === date) {
                    displayDailyManagement(date);
                }
                appointmentModal.style.display = 'none';
                modalAppointmentForm.reset();
            } else {
                showModal("Por favor, complete todos los campos de la cita.");
            }
        });
        
        dailyAppointmentsList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.btn-delete');
            const completeBtn = e.target.closest('.btn-complete');
            if (deleteBtn) {
                const idToDelete = deleteBtn.dataset.id;
                if (confirm('¿Estás seguro de que quieres eliminar esta cita?')) {
                    deleteAppointment(idToDelete);
                }
            }
            if (completeBtn) {
                const idToComplete = completeBtn.dataset.id;
                markAppointmentAsCompleted(idToComplete);
            }
        });


        // --- Client Management Logic (NO MODIFICADA) ---
        const clientForm = document.getElementById('clientForm');
        const clientNameInput = document.getElementById('clientName');
        const clientPhoneInput = document.getElementById('clientPhone');
        const clientNotesInput = document.getElementById('clientNotes');
        const saveClientBtn = document.getElementById('saveClientBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const clientsList = document.getElementById('clientsList');
        const noClientsMessage = document.getElementById('noClientsMessage');
        
        // Client Details elements
        const clientDetailsName = document.getElementById('clientDetailsName');
        const clientDetailsPhone = document.getElementById('clientDetailsPhone');
        const clientDetailsCall = document.getElementById('clientDetailsCall');
        const clientDetailsWhatsApp = document.getElementById('clientDetailsWhatsApp');
        const clientCutsHistoryList = document.getElementById('clientCutsHistoryList');
        const noCutsMessage = document.getElementById('noCutsMessage');
        const cutCountDisplay = document.getElementById('cutCountDisplay');

        function loadClients() {
            return JSON.parse(localStorage.getItem('barbershopClients')) || [];
        }

        function saveClients(clients) {
            localStorage.setItem('barbershopClients', JSON.stringify(clients));
        }

        function renderClients() {
            const clients = loadClients();
            clientsList.innerHTML = '';

            if (clients.length === 0) {
                noClientsMessage.style.display = 'block';
            } else {
                noClientsMessage.style.display = 'none';
                clients.forEach(client => {
                    const clientItem = document.createElement('div');
                    clientItem.className = 'client-item flex justify-between items-center';
                    clientItem.innerHTML = `
                        <div>
                            <p class="text-lg font-semibold">${client.name}</p>
                            <p class="text-sm text-gray-400">${client.phone}</p>
                        </div>
                        <div class="flex space-x-2 items-center">
                            <button class="btn-secondary px-3 py-1 text-sm edit-client-btn" data-id="${client.id}">Editar</button>
                            <button class="btn-delete px-3 py-1 text-sm delete-client-btn" data-id="${client.id}">Eliminar</button>
                        </div>
                    `;
                    clientItem.dataset.id = client.id;
                    clientsList.appendChild(clientItem);
                });
            }
        }
        
        function loadCuts() { 
            // Función placeholder, ya que los cortes están en dailyStats pero es mejor separarlos
            return JSON.parse(localStorage.getItem('barbershopCutsHistory')) || [];
        }
        function saveCuts(cuts) {
             localStorage.setItem('barbershopCutsHistory', JSON.stringify(cuts));
        }
        
        function deleteClient(id) {
            let clients = loadClients();
            clients = clients.filter(c => c.id !== id);
            saveClients(clients);
            renderClients();
        }

        clientsList.addEventListener('click', (e) => {
            const targetBtn = e.target.closest('button');
            const targetDiv = e.target.closest('.client-item');

            if (targetBtn && targetBtn.classList.contains('delete-client-btn')) {
                const clientId = targetBtn.dataset.id;
                if (confirm('¿Estás seguro de que quieres eliminar este cliente y todo su historial de cortes?')) {
                    deleteClient(clientId);
                    // Also delete client's cuts history
                    let cuts = loadCuts();
                    cuts = cuts.filter(cut => cut.clientId !== clientId);
                    saveCuts(cuts);
                    showModal("Cliente y su historial de cortes eliminados.");
                }
            } else if (targetBtn && targetBtn.classList.contains('edit-client-btn')) {
                const clientId = targetBtn.dataset.id;
                startEditClient(clientId);
            } else if (targetDiv && targetDiv.dataset.id) {
                const clientId = targetDiv.dataset.id;
                displayClientDetails(clientId);
            }
        });

        function startEditClient(id) {
            const clients = loadClients();
            const client = clients.find(c => c.id === id);
            if (client) {
                clientNameInput.value = client.name;
                clientPhoneInput.value = client.phone;
                clientNotesInput.value = client.notes;
                clientForm.dataset.editingId = client.id;
                saveClientBtn.textContent = 'Actualizar Cliente';
                cancelEditBtn.classList.remove('hidden');
            }
        }

        function resetClientForm() {
            clientForm.reset();
            clientForm.dataset.editingId = '';
            saveClientBtn.textContent = 'Guardar Cliente';
            cancelEditBtn.classList.add('hidden');
        }

        cancelEditBtn.addEventListener('click', resetClientForm);


        clientForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const clientName = clientNameInput.value.trim();
            const clientPhone = clientPhoneInput.value.trim();
            const clientNotes = clientNotesInput.value.trim();
            const editingId = clientForm.dataset.editingId;

            let clients = loadClients();

            if (editingId) {
                // Update existing client
                const clientIndex = clients.findIndex(c => c.id === editingId);
                if (clientIndex > -1) {
                    clients[clientIndex].name = clientName;
                    clients[clientIndex].phone = clientPhone;
                    clients[clientIndex].notes = clientNotes;
                }
            } else {
                // Add new client
                const newClient = {
                    id: Date.now().toString(),
                    name: clientName,
                    phone: clientPhone,
                    notes: clientNotes
                };
                clients.push(newClient);
            }

            saveClients(clients);
            resetClientForm();
            renderClients();
        });


        function displayClientDetails(id) {
            const clients = loadClients();
            const client = clients.find(c => c.id === id);
            
            if (client) {
                clientDetailsName.textContent = client.name;
                clientDetailsPhone.textContent = client.phone;

                // Update phone links
                if (client.phone) {
                    clientDetailsCall.href = `tel:${client.phone}`;
                    clientDetailsCall.classList.remove('hidden');
                    // WhatsApp link format might vary by country code
                    // For Argentina (+54), remove leading 9 from the phone number
                    const whatsAppPhone = client.phone.startsWith('+549') ? client.phone.replace('+549', '+54') : client.phone;
                    clientDetailsWhatsApp.href = `https://wa.me/${whatsAppPhone}?text=Hola%20${encodeURIComponent(client.name)}%2C%20quer%C3%ADa%20confirmar%20tu%20pr%C3%B3xima%20cita.`;
                    clientDetailsWhatsApp.classList.remove('hidden');
                } else {
                    clientDetailsCall.classList.add('hidden');
                    clientDetailsWhatsApp.classList.add('hidden');
                }

                showScreen(clientDetailsScreen);
                renderCutsHistory(id);
            }
        }
        
        function renderCutsHistory(clientId) {
            // Actualmente no se registra el clientId en los cortes, se necesitaría una refactorización mayor.
            // Por ahora, esta función queda como placeholder.
            clientCutsHistoryList.innerHTML = '';
            noCutsMessage.style.display = 'block';
            cutCountDisplay.textContent = '0';
        }


        // --- Cut Counter Logic (NO MODIFICADA) ---
        const dailyCutsDisplay = document.getElementById('dailyCutsDisplay');
        const dailyEarningsDisplay = document.getElementById('dailyEarningsDisplay');
        const cutAmountInput = document.getElementById('cutAmount');
        const registerTransferBtn = document.getElementById('registerTransferBtn');
        const registerCashBtn = document.getElementById('registerCashBtn');
        const undoLastCutBtn = document.getElementById('undoLastCutBtn');
        const transferCutsDisplay = document.getElementById('transferCutsDisplay');
        const cashCutsDisplay = document.getElementById('cashCutsDisplay');
        
        function getTodayISO() {
            return new Date().toISOString().slice(0, 10);
        }

        function loadDailyStats() {
            const today = getTodayISO();
            const rawStats = localStorage.getItem(`dailyStats_${today}`);
            const stats = rawStats ? JSON.parse(rawStats) : {
                date: today,
                cuts: 0,
                earnings: 0,
                cashCuts: 0,
                transferCuts: 0,
                lastCuts: [] // Modificado para ser un array
            };
            
            stats.cuts = parseFloat(stats.cuts) || 0;
            stats.earnings = parseFloat(stats.earnings) || 0;
            stats.cashCuts = parseFloat(stats.cashCuts) || 0;
            stats.transferCuts = parseFloat(stats.transferCuts) || 0;
            // Asegurarse de que lastCuts sea un array
            stats.lastCuts = Array.isArray(stats.lastCuts) ? stats.lastCuts : [];

            dailyCutsDisplay.textContent = stats.cuts;
            dailyEarningsDisplay.textContent = stats.earnings.toFixed(2);
            transferCutsDisplay.textContent = stats.transferCuts;
            cashCutsDisplay.textContent = stats.cashCuts;

            return stats;
        }

        function saveDailyStats(stats) {
            localStorage.setItem(`dailyStats_${stats.date}`, JSON.stringify(stats));
        }

        function updateDashboardStats() {
            const stats = loadDailyStats();
            if (dashboardDailyCuts) {
                dashboardDailyCuts.textContent = stats.cuts;
            }
            if (dashboardDailyEarnings) {
                dashboardDailyEarnings.textContent = `$${stats.earnings.toFixed(2)}`;
            }
        }
        
        function registerCut(paymentMethod) {
            const cutAmount = parseFloat(cutAmountInput.value);
            if (isNaN(cutAmount) || cutAmount <= 0) {
                showModal("Por favor, ingrese un monto válido.");
                return;
            }
            
            let stats = loadDailyStats();
            stats.cuts += 1;
            stats.earnings += cutAmount;
            
            const cutData = {
                id: Date.now().toString(),
                amount: cutAmount,
                paymentMethod,
                timestamp: Date.now(),
                date: getTodayISO()
            };
            
            if (paymentMethod === 'cash') {
                stats.cashCuts += 1;
                cutData.type = 'cash';
            } else {
                stats.transferCuts += 1;
                cutData.type = 'transfer';
            }
            
            // Guardar el corte en la lista de historial
            stats.lastCuts.push(cutData);
            
            saveDailyStats(stats);
            loadDailyStats(); 
            updateDashboardStats(); 
            showModal(`¡Corte registrado! Total del día: ${stats.cuts} cortes, $${stats.earnings.toFixed(2)}`);
        }
        
        function undoLastCut() {
            let stats = loadDailyStats();
            if (stats.lastCuts.length > 0) {
                const lastCut = stats.lastCuts.pop(); // Obtiene y elimina el último corte del array
                
                stats.cuts -= 1;
                stats.earnings -= lastCut.amount;
                
                if (lastCut.type === 'cash') {
                    stats.cashCuts -= 1;
                } else {
                    stats.transferCuts -= 1;
                }
                
                saveDailyStats(stats);
                loadDailyStats(); 
                updateDashboardStats();
                showModal("Último corte cancelado.");
            } else {
                showModal("No hay cortes para cancelar.");
            }
        }

        registerTransferBtn.addEventListener('click', () => registerCut('transfer'));
        registerCashBtn.addEventListener('click', () => registerCut('cash'));
        undoLastCutBtn.addEventListener('click', undoLastCut);


        // --- Monthly/Weekly Stats Logic (NO MODIFICADA) ---
        const statsDailyCuts = document.getElementById('statsDailyCuts');
        const statsDailyEarnings = document.getElementById('statsDailyEarnings');
        const statsWeeklyCuts = document.getElementById('statsWeeklyCuts');
        const statsWeeklyEarnings = document.getElementById('statsWeeklyEarnings');
        const statsMonthlyCuts = document.getElementById('statsMonthlyCuts');
        const statsMonthlyEarnings = document.getElementById('statsMonthlyEarnings');
        const statsDayDisplay = document.getElementById('statsDayDisplay');
        const statsMonthDisplay = document.getElementById('statsMonthDisplay');
        const statsPrevDayBtn = document.getElementById('statsPrevDayBtn');
        const statsNextDayBtn = document.getElementById('statsNextDayBtn');
        const statsPrevMonthBtn = document.getElementById('statsPrevMonthBtn');
        const statsNextMonthBtn = document.getElementById('statsNextMonthBtn');
        let currentStatsDisplayDate = new Date();

        function getDatesForWeek(date) {
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1)); 
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                dates.push(day.toISOString().slice(0, 10));
            }
            return dates;
        }

        function getDatesForMonth(year, month) {
            const dates = [];
            const lastDay = new Date(year, month + 1, 0).getDate();
            for (let i = 1; i <= lastDay; i++) {
                const day = new Date(year, month, i);
                dates.push(day.toISOString().slice(0, 10));
            }
            return dates;
        }

        function calculateStats(dateArray) {
            let totalCuts = 0;
            let totalEarnings = 0;
            dateArray.forEach(date => {
                const rawStats = localStorage.getItem(`dailyStats_${date}`);
                if (rawStats) {
                    const stats = JSON.parse(rawStats);
                    totalCuts += parseFloat(stats.cuts) || 0;
                    totalEarnings += parseFloat(stats.earnings) || 0;
                }
            });
            return { cuts: totalCuts, earnings: totalEarnings };
        }

        function updateOverallStatsDisplay() {
            const today = currentStatsDisplayDate.toISOString().slice(0, 10);
            statsDayDisplay.textContent = new Date(today).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            const monthText = currentStatsDisplayDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            statsMonthDisplay.textContent = monthText.charAt(0).toUpperCase() + monthText.slice(1);

            // Daily Stats
            const dailyStats = JSON.parse(localStorage.getItem(`dailyStats_${today}`)) || { cuts: 0, earnings: 0 };
            statsDailyCuts.textContent = parseFloat(dailyStats.cuts) || 0;
            statsDailyEarnings.textContent = `$${(parseFloat(dailyStats.earnings) || 0).toFixed(2)}`;

            // Weekly Stats
            const weeklyDates = getDatesForWeek(currentStatsDisplayDate);
            const weeklyStats = calculateStats(weeklyDates);
            statsWeeklyCuts.textContent = weeklyStats.cuts;
            statsWeeklyEarnings.textContent = `$${weeklyStats.earnings.toFixed(2)}`;

            // Monthly Stats
            const monthlyDates = getDatesForMonth(currentStatsDisplayDate.getFullYear(), currentStatsDisplayDate.getMonth());
            const monthlyStats = calculateStats(monthlyDates);
            statsMonthlyCuts.textContent = monthlyStats.cuts;
            statsMonthlyEarnings.textContent = `$${monthlyStats.earnings.toFixed(2)}`;
        }

        function goToNextDay() {
            currentStatsDisplayDate.setDate(currentStatsDisplayDate.getDate() + 1);
            updateOverallStatsDisplay();
        }

        function goToPreviousDay() {
            currentStatsDisplayDate.setDate(currentStatsDisplayDate.getDate() - 1);
            updateOverallStatsDisplay();
        }

        function goToNextMonthStats() {
            currentStatsDisplayDate.setMonth(currentStatsDisplayDate.getMonth() + 1);
            updateOverallStatsDisplay();
        }

        function goToPreviousMonthStats() {
            currentStatsDisplayDate.setMonth(currentStatsDisplayDate.getMonth() - 1);
            updateOverallStatsDisplay();
        }
        
        statsPrevDayBtn.addEventListener('click', goToPreviousDay);
        statsNextDayBtn.addEventListener('click', goToNextDay);
        statsPrevMonthBtn.addEventListener('click', goToPreviousMonthStats);
        statsNextMonthBtn.addEventListener('click', goToNextMonthStats);


        // --- Custom Modal for Messages (Instead of alert/confirm) ---
        function showModal(message) {
            const modalId = 'custom-modal';
            let modal = document.getElementById(modalId);

            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                        <p id="modal-message" class="text-lg font-semibold mb-4 text-black"></p>
                        <button id="modal-close-btn" class="btn-primary">Cerrar</button>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('modal-close-btn').addEventListener('click', () => {
                    modal.style.display = 'none';
                });
            }

            document.getElementById('modal-message').textContent = message;
            modal.style.display = 'flex';
        }


        // Prevenir el zoom con doble toque en dispositivos táctiles
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        
        // Initial setup when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            showScreen(mainMenuScreen); // Start on the main menu
            loadDailyStats(); 
        });
    </script>
</body>
</html>